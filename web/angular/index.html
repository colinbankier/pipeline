<!doctype html>
<html ng-app>
  <head>
  </head>
  <body>
    <div ng-controller="BuildPipelineController">
      <div>
      <form ng-submit="addStage()">
      <label>Name:</label>
      <input ng-model="newStage.name"/>
      <button>Add a new stage</button>
      </form>
      <div>
        {{pipeline.dotFormat}}
      </div>
      <textarea id="inputGraph" rows="5" style="display: block;" onkeyup="tryDraw();">
        /* Example */
digraph {
    /* Note: HTML labels do not work in IE, which lacks support for &lt;foreignObject&gt; tags. */
    A [label="&lt;div style='padding: 10px;'&gt;A &lt;span style='font-size:32px'&gt;Big&lt;/span&gt; &lt;span style='color:red;'&gt;HTML&lt;/span&gt; Source!&lt;/div&gt;"];
    C;
    E [label="A sink"];
    A -&gt; B -&gt; C;
    B -&gt; D -&gt; E;
    C -&gt; E;
    A -&gt; D [label="&lt;div&gt;A multi-rank &lt;span style='color:blue;'&gt;HTML&lt;/span&gt; edge!&lt;/div&gt;"];
}
  </textarea>
  <svg width=650 height=680>
    <g transform="translate(20,20)"/>
</svg>
    </div>
    <script src="angular.min.js"></script>
    <script src="d3/d3.min.js"></script>
    <script src="dagre-d3.min.js"></script>
    <script src="graphlib-dot.min.js"></script>
    <script>
      var defaultPipeline = {
        stages: [
        {id: 'A'},
        {id: 'B'},
        {id: 'C'}
        ],
        triggers: [
        {from: 'A', to: 'B'},
        {from: 'B', to: 'C'}
        ]
        };

      function BuildPipelineController($scope) {
        var pipeline = { dotFormat: "", stages: defaultPipeline.stages, triggers: defaultPipeline.triggers };
        pipeline.dotFormat = "dotty";
        $scope.pipeline = pipeline;

        $scope.buildDotFormat = function() {
          var dot = "digraph {\n";
          var stages = pipeline.stages;
          var triggers = pipeline.triggers;
          for (var i = 0; i < stages.length; i++) {
            dot = dot + stages[i].id + ";\n";
          };
          for (var i = 0; i < triggers.length; i++) {
            dot = dot + triggers[i].from + " -> " + triggers[i].to + ";\n";
          };
          dot = dot + "}";
          pipeline.dotFormat = dot;
        };

        $scope.newStage = { name: "" };
        $scope.addStage = function() {
          var newStage = {id: $scope.newStage.name};
          var lastStage = pipeline.stages[pipeline.stages.length - 1]
          pipeline.stages.push(newStage);
          var trigger = {from: lastStage.id, to: newStage.id};
          pipeline.triggers.push(trigger);
          $scope.buildDotFormat();
        };

        $scope.buildDotFormat();
      };
      </script>
      <script>
        // Input related code goes here
      //var fs = require('fs');
      //var dot = require('graphlib-dot');


        function graphToURL() {
          var elems = [window.location.protocol, '//',
          window.location.host,
          window.location.pathname,
          '?'];

          var queryParams = [];
          if (debugAlignment) {
            queryParams.push('alignment=' + debugAlignment);
          }
          queryParams.push('graph=' + encodeURIComponent(inputGraph.value));
          elems.push(queryParams.join('&'));

          return elems.join('');
        }

        var inputGraph = document.querySelector("#inputGraph");

        var graphLink = d3.select("#graphLink");

        var oldInputGraphValue;

        var graphRE = /[?&]graph=([^&]+)/;
        var graphMatch = window.location.search.match(graphRE);
        if (graphMatch) {
          inputGraph.value = decodeURIComponent(graphMatch[1]);
        }
        var debugAlignmentRE = /[?&]alignment=([^&]+)/;
        var debugAlignmentMatch = window.location.search.match(debugAlignmentRE);
        var debugAlignment;
        if (debugAlignmentMatch) debugAlignment = debugAlignmentMatch[1];

        function tryDraw() {
          var result;
          if (oldInputGraphValue !== inputGraph.value) {
            inputGraph.setAttribute("class", "");
            oldInputGraphValue = inputGraph.value;
            try {
              result = graphlibDot.parse(inputGraph.value);
              } catch (e) {
              inputGraph.setAttribute("class", "error");
              throw e;
            }

            if (result) {
              // Save link to new graph
              graphLink.attr("href", graphToURL());

              // Cleanup old graph
              var svg = d3.select("svg");

              var renderer = new dagreD3.Renderer();

              // Handle debugAlignment
              renderer.postLayout(function(graph) {
                if (debugAlignment) {
                  // First find necessary delta...
                  var minX = Math.min.apply(null, graph.nodes().map(function(u) {
                    var value = graph.node(u);
                    return value[debugAlignment] - value.width / 2;
                    }));

                    // Update node positions
                    graph.eachNode(function(u, value) {
                      value.x = value[debugAlignment] - minX;
                      });

                      // Update edge positions
                      graph.eachEdge(function(e, u, v, value) {
                        value.points.forEach(function(p) {
                          p.x = p[debugAlignment] - minX;
                          });
                          });
                        }
                        });

                        // Uncomment the following line to get straight edges
                        //renderer.edgeInterpolate('linear');

                        // Custom transition function
                        function transition(selection) {
                          return selection.transition().duration(500);
                        }

                        renderer.transition(transition);

                        var layout = renderer.run(result, svg.select("g"));
                        transition(d3.select("svg"))
                        .attr("width", layout.graph().width + 40)
                        .attr("height", layout.graph().height + 40)
                        d3.select("svg")
                        .call(d3.behavior.zoom().on("zoom", function() {
                          var ev = d3.event;
                          svg.select("g")
                          .attr("transform", "translate(" + ev.translate + ") scale(" + ev.scale + ")");
                          }));
                        }
                      }
                    }
      </script>
  </body>
</html>
